---
import * as Content from "astro:content"

import Imports from "../../components/common_imports.astro"
import Metadata from "../../components/common_metadata.astro"
import Header from "../../components/header.astro"
import Footer from "../../components/footer.astro"
import AppsList from "../../components/apps_list.astro"
import Pagination from "../../components/pagination.astro"

import categories from "../../categories.json" with { type: "json" }
import { live } from "../../validate_hosted_apps.js"

const characters = [ "1", "A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z" ]

export async function getStaticPaths() {
	const characters = [ "1", "A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z" ]
	const pages = characters.flatMap(page => 
		categories.map(category => ({
			params: { category: category.slug, page },
			props: { category }
		}))
	)
	return pages
}

let { category, page } = Astro.params

let packaged = await Content.getCollection("metadata", app => app.data.app_type != "hosted")

let apps = packaged.concat(live).filter(function(app) {
	if(! app.data.categories.includes(category)) {
		return false
	}
	let name = app.data.name["en-US"] ?? app.data.name.en ?? app.data.name[app.data.default_locale]
	let starting = name[0].toUpperCase()
	if(! characters.includes(starting)) {
		starting = "1"
	}
	return starting == page
})
---

<!doctype html>
<html lang="en">
	<head>
		<Imports/>
		<link rel="stylesheet" href="/lists.css">
		<link rel="stylesheet" href="/pagination.css">
		<script src="/pagination.js" defer></script>
		<link rel="icon" href={ "/icons/" + category + ".png" } type="image/png">
		<Metadata/>
		<title>Page { page } - { Astro.props.category.name } - FF Apps Archive</title>
		<link rel="canonical" href={ "/" + category + "/" }>
	</head>
	<body>
		<Header/>
		<main>
			<header>
				<img src={ "/icons/" + category + ".png" } alt="" width="40" height="40">
				<h2>{ Astro.props.category.name } - Page { page }</h2>
			</header>
			<Pagination current={ page }/>
			<AppsList apps={ apps }/>
			<Pagination current={ page }/>
		</main>
		<Footer/>
	</body>
</html>